function MapLayer(a){this.name=a,this.mainLayer=null,this.leafLayers=[]}function TopoLayer(a,b,c){function d(){this.legend=L.control({position:"bottomright"});var a=this;this.legend.onAdd=function(){var b=L.DomUtil.create("div",a.name+"-legend");return b},this.leafLayers.push(this.legend)}function e(){this.infoBox=L.control(),this.infoBox.onAdd=function(){return this._div=L.DomUtil.create("div","infoBox"),this.update(),this._div},this.infoBox.update=function(a){this._div.innerHTML=a?"<b>"+a.name+"</b>":"Hover over an area"},this.leafLayers.push(this.infoBox)}MapLayer.call(this,a),this.mainLayer=new L.TopoJSON(b,{parent:this,style:this.getStyle,onEachFeature:this.onEachElement}),this.leafLayers.push(this.mainLayer),this.minColor="#fee8c8",this.maxColor="#e34a33",this.data=null,this.clickListeners=new EventListener,c="undefined"==typeof c||c,c&&d.call(this),e.call(this)}function MarkerLayer(a){MapLayer.call(this,a),this.markers=L.markerClusterGroup(),this.leafLayers=[this.markers],this.clickListeners=new EventListener}function SwissMap(a,b){var c=[46.79,8.38];this.leafMap=L.map(a).setView(c,8),this.leafMap.addLayer(new L.TileLayer("http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{minZoom:8,maxZoom:12})),this.leafMap.addLayer(new L.TopoJSON(b,{style:{color:"black",weight:3,fill:"none"}})),this.layers=[]}function TimeLine(a,b){function n(){if(d3.event.sourceEvent&&d3.event.selection){var a=d3.event.selection.map(i.invert),b=a.map(o);if(b[0]>=b[1]){var c=864e5;b[0]=o(b[0])-2*c,b[1]=o(b[0])+2*c}d3.select(this).transition().call(d3.event.target.move,b.map(i)),m.forEach(function(a){a(b)})}}function o(a){for(var c=Math.abs(b[0]-a),d=0,e=1;e<b.length;e++){var f=Math.abs(b[e]-a);f<c&&(d=e,c=f)}return b[d]}var c=1206e6,d=b[0]-c,e=b[b.length-1]+c,f={top:0,right:20,bottom:20,left:20},g=870-f.left-f.right,h=45-f.top-f.bottom,i=d3.scaleTime().domain([d,e]).range([0,g]),j=d3.select("#"+a).append("svg").attr("width",g+f.left+f.right).attr("height",h+f.top+f.bottom).append("g").attr("transform","translate("+f.left+","+f.top+")");j.append("g").attr("class","timeline-axis").attr("transform","translate(0, "+h+")").call(d3.axisBottom().scale(i).ticks(6).tickFormat(d3.timeFormat("%m/%Y"))),j.append("g").attr("class","timeline-axis axis--grid").attr("transform","translate(0, "+h+")").call(d3.axisBottom().scale(i).tickSize(-h).tickValues(b.map(function(a){return new Date(a)})).tickFormat(function(){return null}));var k=d3.brushX().extent([[0,0],[g,h]]).on("end",n),l=j.append("g").attr("class","mainline").call(k);k.move(l,[i(b[0]),i(b[b.length-1])]);var m=[];this.addUpdateListener=function(a){m.push(a)}}function EventListener(){var a=[];this.addListener=function(b){a.push(b)},this.trigger=function(b){a.forEach(function(a){a(b)})}}var SwissTweets=SwissTweets||{};SwissTweets.main={map:null,timeline:null,data:{},topo:{country:null,cantons:null,municipalities:null},htmlMapIds:{density:"densityMap",sentiment:"sentimentMap",event:"eventMap"},htmlTimelineIds:{density:"densityTimeline",sentiment:"sentimentTimeline",event:"eventTimeline"},loading:function(){queue().defer(d3.json,"res/topo/ch-country.json").defer(d3.json,"res/topo/ch-cantons.json").defer(d3.json,"res/topo/ch-municipalities.json").await(this.init)},init:function(a,b,c,d){a&&alert(a),SwissTweets.main.topo.country=b,SwissTweets.main.topo.cantons=c,SwissTweets.main.topo.municipalities=d,SwissTweets.main.loadData("density")},cleanData:function(a){null!=SwissTweets.main.map&&SwissTweets.main.map.destroy(),SwissTweets.main.map=null,SwissTweets.main.timeline=null,SwissTweets.main.data={},document.getElementById(SwissTweets.main.htmlMapIds[a]).innerHTML="",document.getElementById(SwissTweets.main.htmlTimelineIds[a]).innerHTML=""},loadData:function(a){var b=document.getElementById(a);b.getElementsByClassName("loader")[0].style.display="block",b.getElementsByClassName("loaded")[0].style.display="none","density"==a?SwissTweets.density.loadData():"sentiment"==a?SwissTweets.sentiment.loadData():"event"==a&&SwissTweets.event.loadData()},changeTab:function(a){SwissTweets.main.cleanData(a),SwissTweets.main.loadData(a)},endLoading:function(a){var b=document.getElementById(a);b.getElementsByClassName("loader")[0].style.display="none",b.getElementsByClassName("loaded")[0].style.display="block",SwissTweets.main.map.refreshSize()}},SwissTweets.density={layer:"cantons",loadData:function(){queue().defer(d3.json,"res/density/canton_density.json").defer(d3.json,"res/density/municipality_density.json").await(SwissTweets.density.processData),document.getElementById("density").getElementsByClassName("zoom-level-btn")[0].onclick=SwissTweets.density.changeLayer},processData:function(a,b,c){if(a)throw a;SwissTweets.main.data.cantons=b,SwissTweets.main.data.municipalities=c,SwissTweets.main.data.dates=b.cantons.map(function(a){return a.date});var d=[b.cantons[0].date,b.cantons[b.cantons.length-1].date];SwissTweets.density.updateDates(d[0],d[1]);var e=new TimeLine("densityTimeline",SwissTweets.main.data.dates);e.addUpdateListener(function(a){SwissTweets.density.updateDates(a[0],a[1])}),SwissTweets.main.timeline=e,SwissTweets.main.endLoading("density")},updateDates:function(a,b){SwissTweets.density.start=a,SwissTweets.density.end=b;for(var c="cantons"===SwissTweets.density.layer?SwissTweets.main.data.cantons.cantons:SwissTweets.main.data.municipalities.municipalities,d={},e=0;e<c.length;e++)if(a<=c[e].date&&c[e].date<=b)for(var f=0;f<c[e].data.length;f++){var g=c[e].data[f];d[g.id]||(d[g.id]=0),d[g.id]+=g.nbr}null==SwissTweets.main.map&&SwissTweets.density.loadMap(),SwissTweets.main.map.updateData(SwissTweets.density.layer,d)},loadMap:function(){var a=new SwissMap("densityMap",SwissTweets.main.topo.country),b=function(b){a.leafMap.fitBounds(b.target.getBounds())},c=new TopoLayer("cantons",SwissTweets.main.topo.cantons);c.addClickListener(SwissTweets.density.clickInfo),c.addClickListener(b);var d=new TopoLayer("municipalities",SwissTweets.main.topo.municipalities);d.addClickListener(SwissTweets.density.clickInfo),d.addClickListener(b),a.addLayer(c),a.addLayer(d),a.enableLayer("cantons"),SwissTweets.main.map=a},clickInfo:function(a){var b=a.target.options.parent;document.getElementById("densityInfos").innerHTML="<span class='name'>Name : "+a.target.feature.properties.name+"</span><br/><span class='number'>Number : "+b.data[a.target.feature.id]+"</span>"},changeLayer:function(){var a=SwissTweets.main.map;"cantons"===SwissTweets.density.layer?(a.disableLayer("cantons"),a.enableLayer("municipalities"),SwissTweets.density.layer="municipalities"):(a.disableLayer("municipalities"),a.enableLayer("cantons"),SwissTweets.density.layer="cantons"),SwissTweets.density.updateDates(SwissTweets.density.start,SwissTweets.density.end)}},SwissTweets.sentiment={layer:"cantons",loadData:function(){queue().defer(d3.json,"res/sentiment/canton_sentiment.json").defer(d3.json,"res/sentiment/municipality_sentiment.json").await(SwissTweets.sentiment.processData),document.getElementById("sentiment").getElementsByClassName("zoom-level-btn")[0].onclick=SwissTweets.sentiment.changeLayer},processData:function(a,b,c){if(a)throw a;SwissTweets.main.data.cantons=b,SwissTweets.main.data.municipalities=c,SwissTweets.main.data.dates=b.cantons.map(function(a){return a.date});var d=[b.cantons[0].date,b.cantons[b.cantons.length-1].date];SwissTweets.sentiment.updateDates(d[0],d[1]);var e=new TimeLine("sentimentTimeline",SwissTweets.main.data.dates);e.addUpdateListener(function(a){SwissTweets.sentiment.updateDates(a[0],a[1])}),SwissTweets.main.timeline=e,SwissTweets.main.endLoading("sentiment")},updateDates:function(a,b){SwissTweets.sentiment.start=a,SwissTweets.sentiment.end=b;for(var c="cantons"===SwissTweets.sentiment.layer?SwissTweets.main.data.cantons.cantons:SwissTweets.main.data.municipalities.municipalities,d={},e=0;e<c.length;e++)if(a<=c[e].date&&c[e].date<=b)for(var f=0;f<c[e].data.length;f++){var g=c[e].data[f];d[g.id]||(d[g.id]=0),d[g.id]+=g.nbr}null==SwissTweets.main.map&&SwissTweets.sentiment.loadMap(),SwissTweets.main.map.updateData(SwissTweets.sentiment.layer,d)},loadMap:function(){var a=new SwissMap("sentimentMap",SwissTweets.main.topo.country),b=function(b){a.leafMap.fitBounds(b.target.getBounds())},c=new TopoLayer("cantons",SwissTweets.main.topo.cantons);c.setColors("#e34a33","#2AB23B"),c.addClickListener(SwissTweets.sentiment.clickInfo),c.addClickListener(b);var d=new TopoLayer("municipalities",SwissTweets.main.topo.municipalities);d.setColors("#e34a33","#2AB23B"),d.addClickListener(SwissTweets.sentiment.clickInfo),d.addClickListener(b),a.addLayer(c),a.addLayer(d),a.enableLayer("cantons"),SwissTweets.main.map=a},clickInfo:function(a){var b=a.target.options.parent;document.getElementById("sentimentInfos").innerHTML="<span class='name'>Name : "+a.target.feature.properties.name+"</span><br/><span class='number'>Sentiment (-1 = bad ; +1 = good): "+b.data[a.target.feature.id]+"</span>"},changeLayer:function(){var a=SwissTweets.main.map;"cantons"===SwissTweets.sentiment.layer?(a.disableLayer("cantons"),a.enableLayer("municipalities"),SwissTweets.sentiment.layer="municipalities"):(a.disableLayer("municipalities"),a.enableLayer("cantons"),SwissTweets.sentiment.layer="cantons"),SwissTweets.sentiment.updateDates(SwissTweets.sentiment.start,SwissTweets.sentiment.end)}},SwissTweets.event={loadData:function(){queue().defer(d3.json,"res/events/events.json").await(SwissTweets.event.processData)},processData:function(a,b){if(a)throw a;SwissTweets.main.data.events=b,SwissTweets.main.data.dates=b.events.map(function(a){return a.date});var c=[b.events[0].date,b.events[b.events.length-1].date];SwissTweets.event.updateDates(c[0],c[1]);var d=new TimeLine("eventTimeline",SwissTweets.main.data.dates);d.addUpdateListener(function(a){SwissTweets.event.updateDates(a[0],a[1])}),SwissTweets.main.timeline=d,SwissTweets.main.endLoading("event")},updateDates:function(a,b){SwissTweets.event.start=a,SwissTweets.event.end=b;for(var c=SwissTweets.main.data.events.events,d=[],e=0;e<c.length;e++)if(a<=c[e].date&&c[e].date<=b)for(var f=0;f<c[e].data.length;f++){var g=c[e].data[f];d.push(g)}null==SwissTweets.main.map&&SwissTweets.event.loadMap(),SwissTweets.main.map.updateData("events",d)},loadMap:function(){var a=new SwissMap("eventMap",SwissTweets.main.topo.country),b=new MarkerLayer("events");b.addClickListener(SwissTweets.event.clickInfo);var c=new TopoLayer("cantons",SwissTweets.main.topo.cantons,!1);a.addLayer(b),a.addLayer(c),a.enableLayer("events"),a.enableLayer("cantons"),SwissTweets.main.map=a},clickInfo:function(a){for(var b=a.target.options.data,c=new Date(b.date),d="",e=0;e<b.tweets.length;e++)d+=b.tweets[e]+"<br/>";document.getElementById("eventInfos").innerHTML="<span class='name'>Name : "+b.name+"</span><br/><span class='date'>Date : "+c.getDate()+" - "+c.getMonth()+" - "+c.getFullYear()+"</span><br/><span class='keywords'>Tweets concerned :<br/>"+d+"</span>"}},MapLayer.prototype.onEachElement=function(a,b){throw"Abstract method onEachElement not implemented"},MapLayer.prototype.addToLeafMap=function(a){for(var b=0;b<this.leafLayers.length;b++)this.leafLayers[b].addTo(a)},MapLayer.prototype.removeFromLeafMap=function(){for(var a=0;a<this.leafLayers.length;a++)this.leafLayers[a].remove()},TopoLayer.prototype=Object.create(MapLayer.prototype),TopoLayer.prototype.constructor=TopoLayer,TopoLayer.prototype.onEachElement=function(a,b){function c(a){var b=a.target;b.setStyle({weight:2,color:"#ff8f09"}),L.Browser.ie||L.Browser.opera||L.Browser.edge||b.bringToFront(),b.options.parent.infoBox.update(b.feature.properties)}function d(a){var b=a.target.options.parent;b.mainLayer.eachLayer(function(a){a.setStyle(b.getStyle(a.feature))}),b.infoBox.update()}function e(a){a.target.options.parent.clickListeners.trigger(a)}b.on({mouseover:c,mouseout:d,click:e})},TopoLayer.prototype.addToLeafMap=function(a){MapLayer.prototype.addToLeafMap.call(this,a),this.legend&&this.buildLegend()},TopoLayer.prototype.getStyle=function(a){var b=d3.scaleLinear().domain([0,this.maxData]).range([this.minColor,this.maxColor]),c=b(null!=this.data&&this.data[a.properties.id]?this.data[a.properties.id]:0);return{fillColor:c,fillOpacity:.7,opacity:1,color:"#151515",weight:1}},TopoLayer.prototype.setData=function(a){function d(a,b){var c=d3.scaleLinear().range([150,0]).domain([0,b]),d=d3.axisRight().scale(c);d3.selectAll("."+a+"-axis").call(d).append("text").attr("transform","rotate(-90)").attr("y",30).attr("dy",".71em").style("text-anchor","end")}this.data=a;var b=Object.keys(a).map(function(b){return a[b]});this.maxData=Math.max.apply(null,b),this.legend&&d(this.name,this.maxData);var c=this;this.mainLayer.eachLayer(function(a){a.setStyle(c.getStyle(a.feature))})},MapLayer.prototype.setColors=function(a,b){this.minColor=a,this.maxColor=b,this.legend&&this.buildLegend();var c=this;this.mainLayer.eachLayer(function(a){a.setStyle(c.getStyle(a.feature))})},TopoLayer.prototype.addClickListener=function(a){this.clickListeners.addListener(a)},TopoLayer.prototype.buildLegend=function(){var a=60,b=170,c=a-50,d=b-20,e=d3.select("."+this.name+"-legend").append("svg").attr("width",a).attr("height",b),f=e.append("defs").append("svg:linearGradient").attr("id","gradient").attr("x1","100%").attr("y1","0%").attr("x2","100%").attr("y2","100%").attr("spreadMethod","pad");f.append("stop").attr("offset","0%").attr("stop-color",this.maxColor).attr("stop-opacity",1),f.append("stop").attr("offset","100%").attr("stop-color",this.minColor).attr("stop-opacity",1),e.append("rect").attr("width",c).attr("height",d).style("fill","url(#gradient)").attr("transform","translate(0,10)");var g=d3.scaleLinear().range([d,0]).domain([0,this.maxData]),h=d3.axisRight().scale(g);e.append("g").attr("class","y axis "+this.name+"-axis").attr("transform","translate("+c+", 10)").call(h).append("text").attr("transform","rotate(-90)").attr("y",30).attr("dy",".71em").style("text-anchor","end").text("Number of tweets")},MarkerLayer.prototype=Object.create(MapLayer.prototype),MarkerLayer.prototype.constructor=MarkerLayer,MarkerLayer.prototype.onEachElement=function(a,b){function c(a){a.clickListeners.trigger(a)}b.on({click:c})},MarkerLayer.prototype.setData=function(a){this.markers.clearLayers();var b=this;a.forEach(function(a){var c=L.marker([a.latitude,a.longitude],{data:a}).on("click",b.clickListeners.trigger);b.markers.addLayer(c)})},MarkerLayer.prototype.addClickListener=function(a){this.clickListeners.addListener(a)},SwissMap.prototype.addLayer=function(a){this.layers.push(a)},SwissMap.prototype.updateData=function(a,b){for(var c,d=0;d<this.layers.length;d++)if(a===this.layers[d].name){c=this.layers[d];break}c&&c.setData(b)},SwissMap.prototype.enableLayer=function(a){for(var b=0;b<this.layers.length;b++)if(this.layers[b].name===a){this.layers[b].addToLeafMap(this.leafMap);break}},SwissMap.prototype.disableLayer=function(a){for(var b=0;b<this.layers.length;b++)if(this.layers[b].name===a){this.layers[b].removeFromLeafMap();break}},SwissMap.prototype.destroy=function(){this.layers=null,this.leafMap.remove(),this.leafMap=null},SwissMap.prototype.refreshSize=function(){this.leafMap.invalidateSize()},L.TopoJSON=L.GeoJSON.extend({addData:function(a){if("Topology"===a.type)for(key in a.objects)geojson=topojson.feature(a,a.objects[key]),L.GeoJSON.prototype.addData.call(this,geojson);else L.GeoJSON.prototype.addData.call(this,a)}});