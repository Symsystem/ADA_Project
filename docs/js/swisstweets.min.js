function MapLayer(a){this.name=a,this.mainLayer=null,this.leafLayers=[]}function TopoLayer(a,b,c){function d(){this.legend=L.control({position:"bottomright"});var a=this;this.legend.onAdd=function(){var b=L.DomUtil.create("div",a.name+"-legend");return b},this.leafLayers.push(this.legend)}function e(){this.infoBox=L.control(),this.infoBox.onAdd=function(){return this._div=L.DomUtil.create("div","infoBox"),this.update(),this._div},this.infoBox.update=function(a){this._div.innerHTML=a?"<b>"+a.name+"</b>":"Hover over an area"},this.leafLayers.push(this.infoBox)}MapLayer.call(this,a),this.mainLayer=new L.TopoJSON(b,{parent:this,style:this.getStyle,onEachFeature:this.onEachElement}),this.leafLayers.push(this.mainLayer),this.minColor="#fee8c8",this.maxColor="#e33814",this.data=null,this.clickListeners=new EventListener,c="undefined"==typeof c||c,c&&d.call(this),e.call(this)}function MarkerLayer(a){MapLayer.call(this,a),this.markers=L.markerClusterGroup(),this.leafLayers=[this.markers],this.clickListeners=new EventListener}function SwissMap(a,b){var c=[46.79,8.38];this.leafMap=L.map(a).setView(c,8),this.leafMap.addLayer(new L.TileLayer("http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{minZoom:8,maxZoom:12})),this.leafMap.addLayer(new L.TopoJSON(b,{style:{color:"black",weight:3,fill:"none"}})),this.layers=[]}function TimeLine(a,b,c){function o(){if(d3.event.sourceEvent&&d3.event.selection){var a=d3.event.selection.map(j.invert),b=a.map(p);if(b[0]>=b[1]){var c=864e5;b[0]=p(b[0])-2*c,b[1]=p(b[0])+2*c}d3.select(this).transition().call(d3.event.target.move,b.map(j)),n.forEach(function(a){a(b)})}}function p(a){for(var c=Math.abs(b[0]-a),d=0,e=1;e<b.length;e++){var f=Math.abs(b[e]-a);f<c&&(d=e,c=f)}return b[d]}var d=1206e6,e=b[0]-d,f=b[b.length-1]+d,g={top:0,right:20,bottom:20,left:0},h=1370-g.left-g.right,i=45-g.top-g.bottom,j=d3.scaleTime().domain([e,f]).range([0,h]),k=d3.select("#"+a).append("svg").attr("width",h+g.left+g.right).attr("height",i+g.top+g.bottom).append("g").attr("transform","translate("+g.left+","+g.top+")");k.append("g").attr("class","timeline-axis").attr("transform","translate(0, "+i+")").call(d3.axisBottom().scale(j).ticks(14).tickFormat(d3.timeFormat("%m/%Y"))),k.append("g").attr("class","timeline-axis axis--grid").attr("transform","translate(0, "+i+")").call(d3.axisBottom().scale(j).tickSize(-i).tickValues(b.map(function(a){return new Date(a)})).tickFormat(function(){return null}));var l=d3.brushX().extent([[0,0],[h,i]]).on("end",o),m=k.append("g").attr("class","mainline").call(l);l.move(m,[j(c[0]),j(c[1])]);var n=[];this.addUpdateListener=function(a){n.push(a)}}function EventListener(){var a=[];this.addListener=function(b){a.push(b)},this.trigger=function(b){a.forEach(function(a){a(b)})}}function LogSlider(a,b){this.minpos=0,this.maxpos=50,this.minlval=Math.log(a),this.maxlval=Math.log(b),this.scale=(this.maxlval-this.minlval)/(this.maxpos-this.minpos)}var SwissTweets=SwissTweets||{};SwissTweets.main={map:null,timeline:null,data:{},topo:{country:null,cantons:null,municipalities:null},htmlMapIds:{density:"densityMap",sentiment:"sentimentMap",event:"eventMap"},htmlTimelineIds:{density:"densityTimeline",sentiment:"sentimentTimeline",event:"eventTimeline"},currentTab:"density",loading:function(){queue().defer(d3.json,"res/topo/ch-country.json").defer(d3.json,"res/topo/ch-cantons.json").defer(d3.json,"res/topo/ch-municipalities.json").await(this.init)},init:function(a,b,c,d){a&&alert(a),SwissTweets.main.topo.country=b,SwissTweets.main.topo.cantons=c,SwissTweets.main.topo.municipalities=d,SwissTweets.main.loadData("density")},cleanData:function(){null!=SwissTweets.main.map&&SwissTweets.main.map.destroy(),SwissTweets.main.map=null,SwissTweets.main.timeline=null,SwissTweets.main.data={};var a=SwissTweets.main.currentTab;document.getElementById(SwissTweets.main.htmlMapIds[a]).innerHTML="",document.getElementById(SwissTweets.main.htmlTimelineIds[a]).innerHTML=""},loadData:function(a){for(var b=document.getElementById(SwissTweets.main.currentTab),c=b.getElementsByClassName("loaded"),d=0;d<c.length;d++)c[d].style.display="none";b.getElementsByClassName("loader")[0].style.display="block",SwissTweets.main.currentTab=a,"density"==a?SwissTweets.density.loadData():"sentiment"==a?SwissTweets.sentiment.loadData():"event"==a&&SwissTweets.event.loadData()},changeTab:function(a){SwissTweets.main.cleanData(),SwissTweets.main.loadData(a)},endLoading:function(a){var b=document.getElementById(a);b.getElementsByClassName("loader")[0].style.display="none";for(var c=b.getElementsByClassName("loaded"),d=0;d<c.length;d++)c[d].style.display="block";SwissTweets.main.map.refreshSize(),SwissTweets.main.selectedPeriodInfo(SwissTweets.start,SwissTweets.end)},selectedPeriodInfo:function(a,b){var c=document.getElementsByClassName("periodSelected"),d=new Date(a),e=d.getMonth()+1+"/"+d.getFullYear();if(a!=b){var f=new Date(b);e+=" - "+(f.getMonth()+1)+"/"+f.getFullYear()}for(var g=0;g<c.length;g++)c[g].innerHTML=e}},SwissTweets.density={layer:"cantons",loadData:function(){queue().defer(d3.json,"res/density/canton_density.json").defer(d3.json,"res/density/municipality_density.json").await(SwissTweets.density.processData),document.getElementById("density").getElementsByClassName("zoom-level-btn")[0].onclick=SwissTweets.density.changeLayer},processData:function(a,b,c){if(a)throw a;SwissTweets.main.data.cantons=b,SwissTweets.main.data.municipalities=c,SwissTweets.main.data.dates=b.cantons.map(function(a){return a.date}),SwissTweets.start=b.cantons[0].date,SwissTweets.end=b.cantons[b.cantons.length-1].date,SwissTweets.density.maxValSlider=new LogSlider(0,1),$("#densitySlider").attr("value",50),SwissTweets.density.updateDates(SwissTweets.start,SwissTweets.end);var d=new TimeLine("densityTimeline",SwissTweets.main.data.dates,[SwissTweets.start,SwissTweets.end]);d.addUpdateListener(function(a){SwissTweets.density.updateDates(a[0],a[1]),SwissTweets.main.selectedPeriodInfo(a[0],a[1])}),SwissTweets.main.timeline=d,SwissTweets.main.endLoading("density")},updateDates:function(a,b){SwissTweets.start=a,SwissTweets.end=b;for(var c="cantons"===SwissTweets.density.layer?SwissTweets.main.data.cantons.cantons:SwissTweets.main.data.municipalities.municipalities,d={},e=0;e<c.length;e++)if(a<=c[e].date&&c[e].date<=b)for(var f=0;f<c[e].data.length;f++){var g=c[e].data[f];d[g.id]||(d[g.id]=0),d[g.id]+=g.nbr}var h=Object.keys(d).map(function(a){return d[a]}),i=Math.min.apply(null,h),j=Math.max.apply(null,h);SwissTweets.density.maxValSlider.setBounds(0==i?1:i,j),$("#maxValueDensity").html("Max color: "+j+" tweets"),d.min=0,d.max=j,null==SwissTweets.main.map&&SwissTweets.density.loadMap(),SwissTweets.main.map.updateData(SwissTweets.density.layer,d)},loadMap:function(){var a=new SwissMap("densityMap",SwissTweets.main.topo.country),b=function(b){a.leafMap.fitBounds(b.target.getBounds())},c=new TopoLayer("cantons",SwissTweets.main.topo.cantons);c.addClickListener(SwissTweets.density.clickInfo),c.addClickListener(b);var d=new TopoLayer("municipalities",SwissTweets.main.topo.municipalities);d.addClickListener(SwissTweets.density.clickInfo),d.addClickListener(b),a.addLayer(c),a.addLayer(d),a.enableLayer(SwissTweets.density.layer),SwissTweets.main.map=a,$("#densitySlider").on("change",function(){var a=SwissTweets.density.maxValSlider.value(+$(this).val());$("#maxValueDensity").html("Max color: "+a.toFixed(0)+" tweets"),SwissTweets.main.map.setActualMaxValue(SwissTweets.density.layer,a)})},clickInfo:function(a){var b=a.target.options.parent;document.getElementById("densityInfos").innerHTML="<span class='name'>Name: "+a.target.feature.properties.name+"</span><br/><span class='number'>Number of tweets: "+b.data[a.target.feature.id]+"</span>"},changeLayer:function(){var a=SwissTweets.main.map;"cantons"===SwissTweets.density.layer?(a.disableLayer("cantons"),a.enableLayer("municipalities"),SwissTweets.density.layer="municipalities"):(a.disableLayer("municipalities"),a.enableLayer("cantons"),SwissTweets.density.layer="cantons"),SwissTweets.density.updateDates(SwissTweets.start,SwissTweets.end)}},SwissTweets.sentiment={layer:"cantons",loadData:function(){queue().defer(d3.json,"res/sentiment/canton_sentiment.json").defer(d3.json,"res/sentiment/municipality_sentiment.json").await(SwissTweets.sentiment.processData),document.getElementById("sentiment").getElementsByClassName("zoom-level-btn")[0].onclick=SwissTweets.sentiment.changeLayer},processData:function(a,b,c){if(a)throw a;SwissTweets.main.data.cantons=b,SwissTweets.main.data.municipalities=c,SwissTweets.main.data.dates=b.cantons.map(function(a){return a.date}),SwissTweets.start=b.cantons[0].date,SwissTweets.end=b.cantons[b.cantons.length-1].date,SwissTweets.sentiment.updateDates(SwissTweets.start,SwissTweets.end);var d=new TimeLine("sentimentTimeline",SwissTweets.main.data.dates,[SwissTweets.start,SwissTweets.end]);d.addUpdateListener(function(a){SwissTweets.sentiment.updateDates(a[0],a[1]),SwissTweets.main.selectedPeriodInfo(a[0],a[1])}),SwissTweets.main.timeline=d,SwissTweets.main.endLoading("sentiment")},updateDates:function(a,b){SwissTweets.start=a,SwissTweets.end=b;for(var c="cantons"===SwissTweets.sentiment.layer?SwissTweets.main.data.cantons.cantons:SwissTweets.main.data.municipalities.municipalities,d={},e={},f=0;f<c.length;f++)if(a<=c[f].date&&c[f].date<=b)for(var g=0;g<c[f].data.length;g++){var h=c[f].data[g];d[h.id]||(d[h.id]=0,e[h.id]=0),d[h.id]+=h.nbr,e[h.id]+=1}Object.keys(d).map(function(a){d[a]/=e[a]}),null==SwissTweets.main.map&&SwissTweets.sentiment.loadMap(),d.min=-1,d.max=1,SwissTweets.main.map.updateData(SwissTweets.sentiment.layer,d)},loadMap:function(){var a=new SwissMap("sentimentMap",SwissTweets.main.topo.country),b=function(b){a.leafMap.fitBounds(b.target.getBounds())},c=new TopoLayer("cantons",SwissTweets.main.topo.cantons);c.setColors("#e34a33","#2AB23B"),c.addClickListener(SwissTweets.sentiment.clickInfo),c.addClickListener(b);var d=new TopoLayer("municipalities",SwissTweets.main.topo.municipalities);d.setColors("#e34a33","#2AB23B"),d.addClickListener(SwissTweets.sentiment.clickInfo),d.addClickListener(b),a.addLayer(c),a.addLayer(d),a.enableLayer(SwissTweets.sentiment.layer),SwissTweets.main.map=a},clickInfo:function(a){var b=a.target.options.parent;document.getElementById("sentimentInfos").innerHTML="<span class='name'>Name: "+a.target.feature.properties.name+"</span><br/><span class='number'>Sentiment: "+b.data[a.target.feature.id].toFixed(2)+" <i>(-1 = bad, +1 = good)</i></span>"},changeLayer:function(){var a=SwissTweets.main.map;"cantons"===SwissTweets.sentiment.layer?(a.disableLayer("cantons"),a.enableLayer("municipalities"),SwissTweets.sentiment.layer="municipalities"):(a.disableLayer("municipalities"),a.enableLayer("cantons"),SwissTweets.sentiment.layer="cantons"),SwissTweets.sentiment.updateDates(SwissTweets.start,SwissTweets.end)}},SwissTweets.event={loadData:function(){queue().defer(d3.json,"res/events/events.json").await(SwissTweets.event.processData)},processData:function(a,b){if(a)throw a;SwissTweets.main.data.events=b,SwissTweets.main.data.dates=b.events.map(function(a){return a.date}),SwissTweets.start=b.events[0].date,SwissTweets.end=b.events[b.events.length-1].date,SwissTweets.event.updateDates(SwissTweets.start,SwissTweets.end);var c=new TimeLine("eventTimeline",SwissTweets.main.data.dates,[SwissTweets.start,SwissTweets.end]);c.addUpdateListener(function(a){SwissTweets.event.updateDates(a[0],a[1]),SwissTweets.main.selectedPeriodInfo(a[0],a[1])}),SwissTweets.main.timeline=c,SwissTweets.main.endLoading("event")},updateDates:function(a,b){$("#event-mini-loader").show(),SwissTweets.start=a,SwissTweets.end=b;for(var c=SwissTweets.main.data.events.events,d=[],e=0;e<c.length;e++)if(a<=c[e].date&&c[e].date<=b)for(var f=0;f<c[e].data.length;f++){var g=c[e].data[f];d.push(g)}null==SwissTweets.main.map&&SwissTweets.event.loadMap(),SwissTweets.main.map.updateData("events",d),$("#event-mini-loader").hide()},loadMap:function(){var a=new SwissMap("eventMap",SwissTweets.main.topo.country),b=new MarkerLayer("events");b.addClickListener(SwissTweets.event.clickInfo);var c=new TopoLayer("cantons",SwissTweets.main.topo.cantons,!1);a.addLayer(b),a.addLayer(c),a.enableLayer("events"),a.enableLayer("cantons"),SwissTweets.main.map=a},clickInfo:function(a){for(var b=a.target.options.data,c=new Date(b.date),d="",e=0;e<b.tweets.length;e++)d+="<li>"+b.tweets[e]+"</li>";document.getElementById("eventInfos").innerHTML="<p><span class='name'>Name: "+b.name+"</span><br/><span class='date'>Date: "+c.getDate()+"/"+c.getMonth()+"/"+c.getFullYear()+"</span><br/><span class='date'>Number of tweets: "+b.number_of_tweets+"</span></p><div class='panel panel-default panel-tweets'><div class='panel-heading'><i class='fa fa-twitter fa-fw'></i> List of tweets</div><div class='panel-body'><ul>"+d+"</ul></div></div>"}},MapLayer.prototype.onEachElement=function(a,b){throw"Abstract method onEachElement not implemented"},MapLayer.prototype.addToLeafMap=function(a){for(var b=0;b<this.leafLayers.length;b++)this.leafLayers[b].addTo(a)},MapLayer.prototype.removeFromLeafMap=function(){for(var a=0;a<this.leafLayers.length;a++)this.leafLayers[a].remove()},TopoLayer.prototype=Object.create(MapLayer.prototype),TopoLayer.prototype.constructor=TopoLayer,TopoLayer.prototype.onEachElement=function(a,b){function c(a){var b=a.target;b.setStyle({weight:2,color:"#ff8f09"}),L.Browser.ie||L.Browser.opera||L.Browser.edge||b.bringToFront(),b.options.parent.infoBox.update(b.feature.properties)}function d(a){var b=a.target.options.parent;b.mainLayer.eachLayer(function(a){a.setStyle(b.getStyle(a.feature))}),b.infoBox.update()}function e(a){a.target.options.parent.clickListeners.trigger(a)}b.on({mouseover:c,mouseout:d,click:e})},TopoLayer.prototype.addToLeafMap=function(a){MapLayer.prototype.addToLeafMap.call(this,a),this.legend&&this.buildLegend()},TopoLayer.prototype.getStyle=function(a){var c,b=d3.scaleLinear().domain([this.minData,this.actualMaxValue]).range([this.minColor,this.maxColor]);if(null!=this.data&&this.data[a.properties.id]){var d=this.data[a.properties.id];c=b(d>this.actualMaxValue?this.actualMaxValue:d<this.minData?this.minData:d)}else c="#b0b0b0";return{fillColor:c,fillOpacity:.7,opacity:1,color:"#151515",weight:1}},TopoLayer.prototype.setData=function(a){this.data=a,this.maxData=a.max,this.actualMaxValue=this.maxData,this.minData=a.min,this.setActualMaxValue(this.actualMaxValue)},TopoLayer.prototype.setActualMaxValue=function(a){function c(a,b,c){var d=d3.scaleLinear().range([150,0]).domain([b,c]),e=d3.axisRight().scale(d);d3.selectAll("."+a+"-axis").call(e).append("text").attr("transform","rotate(-90)").attr("y",30).attr("dy",".71em").style("text-anchor","end")}this.actualMaxValue=a;var b=this;this.mainLayer.eachLayer(function(a){a.setStyle(b.getStyle(a.feature))}),this.legend&&c(this.name,this.minData,a)},MapLayer.prototype.setColors=function(a,b){this.minColor=a,this.maxColor=b;var c=this;this.mainLayer.eachLayer(function(a){a.setStyle(c.getStyle(a.feature))})},TopoLayer.prototype.addClickListener=function(a){this.clickListeners.addListener(a)},TopoLayer.prototype.buildLegend=function(){var a=75,b=170,c=10,d=b-20,e=d3.select("."+this.name+"-legend").append("svg").attr("width",a).attr("height",b),f=e.append("defs").append("svg:linearGradient").attr("id","gradient").attr("x1","100%").attr("y1","0%").attr("x2","100%").attr("y2","100%").attr("spreadMethod","pad");f.append("stop").attr("offset","0%").attr("stop-color",this.maxColor).attr("stop-opacity",1),f.append("stop").attr("offset","100%").attr("stop-color",this.minColor).attr("stop-opacity",1),e.append("rect").attr("width",c).attr("height",d).style("fill","url(#gradient)").attr("transform","translate(0,10)");var g=d3.scaleLinear().range([d,0]).domain([this.minData,this.maxData]),h=d3.axisRight().scale(g);e.append("g").attr("class","y axis "+this.name+"-axis").attr("transform","translate("+c+", 10)").call(h).append("text").attr("transform","rotate(-90)").attr("y",30).attr("dy",".71em").style("text-anchor","end")},MarkerLayer.prototype=Object.create(MapLayer.prototype),MarkerLayer.prototype.constructor=MarkerLayer,MarkerLayer.prototype.onEachElement=function(a,b){function c(a){a.clickListeners.trigger(a)}b.on({click:c})},MarkerLayer.prototype.setData=function(a){this.markers.clearLayers();var b=this;a.forEach(function(a){var c=L.marker([a.latitude,a.longitude],{data:a}).on("click",b.clickListeners.trigger);b.markers.addLayer(c)})},MarkerLayer.prototype.addClickListener=function(a){this.clickListeners.addListener(a)},SwissMap.prototype.addLayer=function(a){this.layers.push(a)},SwissMap.prototype.updateData=function(a,b){for(var c,d=0;d<this.layers.length;d++)if(a===this.layers[d].name){c=this.layers[d];break}c&&c.setData(b)},SwissMap.prototype.setActualMaxValue=function(a,b){for(var c,d=0;d<this.layers.length;d++)if(a===this.layers[d].name){c=this.layers[d];break}c&&c instanceof TopoLayer&&c.setActualMaxValue(b)},SwissMap.prototype.enableLayer=function(a){for(var b=0;b<this.layers.length;b++)if(this.layers[b].name===a){this.layers[b].addToLeafMap(this.leafMap);break}},SwissMap.prototype.disableLayer=function(a){for(var b=0;b<this.layers.length;b++)if(this.layers[b].name===a){this.layers[b].removeFromLeafMap();break}},SwissMap.prototype.destroy=function(){this.layers=null,this.leafMap.remove(),this.leafMap=null},SwissMap.prototype.refreshSize=function(){this.leafMap.invalidateSize()},L.TopoJSON=L.GeoJSON.extend({addData:function(a){if("Topology"===a.type)for(key in a.objects)geojson=topojson.feature(a,a.objects[key]),L.GeoJSON.prototype.addData.call(this,geojson);else L.GeoJSON.prototype.addData.call(this,a)}}),LogSlider.prototype={setBounds:function(a,b){this.minlval=Math.log(a),this.maxlval=Math.log(b),this.scale=(this.maxlval-this.minlval)/(this.maxpos-this.minpos)},value:function(a){return Math.exp((a-this.minpos)*this.scale+this.minlval)},position:function(a){return this.minpos+(Math.log(a)-this.minlval)/this.scale}};